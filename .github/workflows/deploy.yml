name: Deploy Next.js to Oracle VM

on:
  pull_request:
    branches:
      - main
    types: [closed]  # PRì´ ì¢…ë£Œë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰

jobs:
  deploy:
    if: github.event.pull_request.merged == true  # ë¨¸ì§€ëœ PRë§Œ ì‹¤í–‰
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Oracle VM
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd /home/ubuntu/your_project
            git pull origin main
            npm install
            npm run build
            pm2 restart nextjs || pm2 start npm --name "nextjs" -- run start

      - name: Notify Discord (Country-based)
        if: always()
        run: |
          ACTOR="${{ github.actor }}"
          MESSAGE="ğŸš€ **[Oracle VM ë°°í¬ ì™„ë£Œ]**\nâ–« ë¸Œëœì¹˜: main\nâ–« ì»¤ë°‹: ${{ github.sha }}\nâ–« ì‘ì„±ì: $ACTOR"

          if [[ "$ACTOR" == vn-* ]]; then
            WEBHOOK="${{ secrets.DISCORD_WEBHOOK_VN }}"
          elif [[ "$ACTOR" == in-* ]]; then
            WEBHOOK="${{ secrets.DISCORD_WEBHOOK_IN }}"
          else
            WEBHOOK="${{ secrets.DISCORD_WEBHOOK }}"
          fi

          curl -X POST $WEBHOOK \
            -H "Content-Type: application/json" \
            -d "{
              \"username\": \"Deploy Bot\",
              \"content\": \"$MESSAGE\"
            }"

      - name: Notify QA Results
        if: always()
        run: |
          QA_RESULT="âœ… Lint í†µê³¼\nâœ… Unit Test í†µê³¼"
          curl -X POST ${{ secrets.DISCORD_WEBHOOK_QA }} \
            -H "Content-Type: application/json" \
            -d "{
              \"username\": \"QA Bot\",
              \"content\": \"ğŸ” **[QA ê²°ê³¼]**\n$QA_RESULT\nâ–« ì‘ì„±ì: ${{ github.actor }}\"
            }"

      - name: Notify on Deploy Failure
        if: failure()
        run: |
          curl -X POST ${{ secrets.DISCORD_WEBHOOK_FAILURE }} \
            -H "Content-Type: application/json" \
            -d '{
              "username": "Deploy Bot",
              "content": "ğŸš¨ **[ë°°í¬ ì‹¤íŒ¨]**\nâ–« ë¸Œëœì¹˜: main\nâ–« ì»¤ë°‹: ${{ github.sha }}\nâ–« ì‘ì„±ì: ${{ github.actor }}"
            }'

      - name: Restore .env.production on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "${{ secrets.DISCORD_ENV_B64 }}" | base64 -d > /home/ubuntu/your_project/.env.production

      - name: ê¸°ë¡ì„ Airtableì— ì €ì¥
        env:
          AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
          GIT_AUTHOR: ${{ github.actor }}
          GIT_BRANCH: main
          GIT_SHA: ${{ github.sha }}
        run: |
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          cat <<EOF | curl -X POST "https://api.airtable.com/v0/app3A3wNTuBjyz8LM/DeployHistory" \
            -H "Authorization: Bearer $AIRTABLE_TOKEN" \
            -H "Content-Type: application/json" \
            --data @-
          {
            "fields": {
              "Date": "$DATE",
              "Author": "$GIT_AUTHOR",
              "Branch": "$GIT_BRANCH",
              "Commit": "$GIT_SHA",
              "QA": "í†µê³¼",
              "Status": "ì„±ê³µ"
            }
          }
          EOF
