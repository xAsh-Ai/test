name: Deploy Next.js to Oracle VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Oracle VM
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd /home/ubuntu/your_project
            git pull origin main
            npm install
            npm run build
            pm2 restart nextjs || pm2 start npm --name "nextjs" -- run start

      - name: Notify Discord
        if: always()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "username": "Deploy Bot",
                 "content": "üöÄ **[Oracle VM Î∞∞Ìè¨ ÏôÑÎ£å]**\n‚ñ´ Î∏åÎûúÏπò: ${{ github.ref_name }}\n‚ñ´ Ïª§Î∞ã: ${{ github.sha }}\n‚ñ´ ÏûëÏÑ±Ïûê: ${{ github.actor }}"
               }' \
               ${{ secrets.DISCORD_WEBHOOK }}

      # üìÑ QA Í≤∞Í≥º ÏïåÎ¶º
      - name: Notify QA Results
        if: always()
        run: |
          QA_RESULT="‚úÖ Lint ÌÜµÍ≥º\n‚úÖ Unit Test ÌÜµÍ≥º"
          curl -X POST ${{ secrets.DISCORD_WEBHOOK_QA }} \
            -H "Content-Type: application/json" \
            -d "{
              \"username\": \"QA Bot\",
              \"content\": \"üîç **[QA Í≤∞Í≥º]**\n$QA_RESULT\n‚ñ´ ÏûëÏÑ±Ïûê: ${{ github.actor }}\"
            }"

      # ‚ùå Î∞∞Ìè¨ Ïã§Ìå® Ïãú ÏïåÎ¶º
      - name: Notify on Deploy Failure
        if: failure()
        run: |
          curl -X POST ${{ secrets.DISCORD_WEBHOOK_FAILURE }} \
            -H "Content-Type: application/json" \
            -d '{
              "username": "Deploy Bot",
              "content": "üö® **[Î∞∞Ìè¨ Ïã§Ìå®]**\n‚ñ´ Î∏åÎûúÏπò: `${{ github.ref_name }}`\n‚ñ´ Ïª§Î∞ã: `${{ github.sha }}`\n‚ñ´ ÏûëÏÑ±Ïûê: `${{ github.actor }}`"
            }'

      #.env.production ÏûêÎèô Ï†ÑÏÜ°
      - name: Restore .env.production on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "${{ secrets.DISCORD_ENV_B64 }}" | base64 -d > /home/ubuntu/your_project/.env.production

      - name: Í∏∞Î°ùÏùÑ AirtableÏóê Ï†ÄÏû•
        env:
          AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
        shell: bash
        run: |
          DATE=$(date "+%Y-%m-%dT%H:%M:%S")
          curl -X POST "https://api.airtable.com/v0/app3A3wNTuBjyz8LM/DeployHistory" \
            -H "Authorization: Bearer $AIRTABLE_TOKEN" \
            -H "Content-Type: application/json" \
            --data @- <<EOF
      {
        "fields": {
          "Date": "$DATE",
          "Author": "$GITHUB_ACTOR",
          "Branch": "$GITHUB_REF_NAME",
          "Commit": "$GITHUB_SHA",
          "QA": "ÌÜµÍ≥º",
          "Status": "ÏÑ±Í≥µ"
        }
      }
EOF
